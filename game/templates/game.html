<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Zack's Digital Journey - Game</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        .character {
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center bottom;
        }
        
        .character.error {
            background-color: rgba(0, 0, 0, 0.3);
        }
    </style>
    <!-- 添加调试脚本 -->
    <script>
        // 全局错误捕获
        window.addEventListener('error', function(event) {
            console.error('全局错误:', event.message, 'at', event.filename, ':', event.lineno);
        });
        
        // 定义游戏初始化标记函数
        window.gameInitMarker = function(message) {
            console.log('[INIT] ' + message);
        };
        
        // 在控制台打印警告消息通知用户
        console.warn('游戏调试模式已启用，按F12打开控制台查看更多信息');
        
        // 添加图片路径修复函数
        window.fixImagePath = function(path) {
            // 将路径标准化，确保以/game-static/开头
            if (path && !path.startsWith('/')) {
                path = '/' + path;
            }
            if (path && path.startsWith('/static/')) {
                path = path.replace('/static/', '/game-static/');
            }
            else if (path && !path.startsWith('/game-static/')) {
                path = '/game-static' + path;
            }
            return path;
        };
        
        // 添加图片加载错误处理
        window.handleImageError = function(element, defaultImage) {
            console.warn('图片加载失败, 使用默认图片', defaultImage);
            if (element) {
                element.classList.add('error');
                defaultImage = window.fixImagePath(defaultImage);
                element.style.backgroundImage = `url(${defaultImage})`;
            }
        };
    </script>
</head>
<body>
    <div class="game-container">
        <!-- 状态栏 -->
        <div class="status-bar">
            <div class="status-item">
                <span>Fans:</span>
                <span id="fans-count">0</span>
            </div>
            <div class="status-item">
                <span>Health:</span>
                <span id="health-value">100</span>
            </div>
            <div class="status-item">
                <span>Social:</span>
                <span id="social-value">50</span>
            </div>
            <div class="status-item">
                <span>Security Awareness:</span>
                <span id="security-value">50</span>
            </div>
            <div class="status-item">
                <span>Day:</span>
                <span id="day-count">1</span>
            </div>
        </div>

        <!-- Quiz 倒计时柱状图容器 -->
        <div id="quiz-timer-bar-container" style="position:absolute;top:70px;left:50%;transform:translateX(-50%);width:90%;height:18px;background:#f1f1f1;border-radius:10px;box-shadow:0 2px 5px rgba(0,0,0,0.2);display:none;z-index:1000;">
            <div id="quiz-timer-bar" style="width:100%;height:100%;background:#4CAF50;border-radius:10px;transition:width 1s linear;"></div>
        </div>

        <!-- Quiz 题目显示容器 -->
        <div id="quiz-container" style="position:absolute;top:100px;left:50%;transform:translateX(-50%);width:80%;max-width:600px;padding:20px;background:rgba(255,255,255,0.95);border-radius:10px;box-shadow:0 4px 20px rgba(0,0,0,0.3);display:none;z-index:1000;">
            <div id="quiz-question-text" style="font-size:20px;color:#333;margin-bottom:15px;text-align:center;">Loading question...</div>
            <div id="quiz-question-choices" style="display:flex;flex-direction:column;gap:10px;"></div>
        </div>

        <!-- 游戏主画面 -->
        <div class="game-screen">
            <div class="background" id="background"></div>
            <div class="character left" id="character-left"></div>
            <div class="character right" id="character-right"></div>
            <div class="dialog-box">
                <div class="speaker-name" id="speaker-name"></div>
                <div class="dialog-text" id="dialog-text"></div>
                <div class="choices" id="choices"></div>
            </div>
        </div>
    </div>
    
    <!-- 先加载资源重定向脚本 -->
    <script src="{{ url_for('static', filename='js/resource_redirect.js') }}?v={{ (now.strftime('%Y%m%d%H%M%S') if now is callable else now.strftime('%Y%m%d%H%M%S')) if now is defined else '' }}"></script>
    
    <!-- 再加载辅助脚本和修复脚本 -->
    <script src="{{ url_for('static', filename='js/image_path_fix.js') }}?v={{ (now.strftime('%Y%m%d%H%M%S') if now is callable else now.strftime('%Y%m%d%H%M%S')) if now is defined else '' }}"></script>
    <script src="{{ url_for('static', filename='js/variable_fix.js') }}?v={{ (now.strftime('%Y%m%d%H%M%S') if now is callable else now.strftime('%Y%m%d%H%M%S')) if now is defined else '' }}"></script>
    <script src="{{ url_for('static', filename='js/game_init_fix.js') }}?v={{ (now.strftime('%Y%m%d%H%M%S') if now is callable else now.strftime('%Y%m%d%H%M%S')) if now is defined else '' }}"></script>
    <script src="{{ url_for('static', filename='js/event_jump_fix.js') }}?v={{ (now.strftime('%Y%m%d%H%M%S') if now is callable else now.strftime('%Y%m%d%H%M%S')) if now is defined else '' }}"></script>
    <script src="{{ url_for('static', filename='js/music_controller.js') }}?v={{ (now.strftime('%Y%m%d%H%M%S') if now is callable else now.strftime('%Y%m%d%H%M%S')) if now is defined else '' }}"></script>
    
    <!-- 然后加载事件处理器 -->
    <script src="{{ url_for('static', filename='js/weekend_event_handler.js') }}?v={{ (now.strftime('%Y%m%d%H%M%S') if now is callable else now.strftime('%Y%m%d%H%M%S')) if now is defined else '' }}"></script>
    <script src="{{ url_for('static', filename='js/weekend_event_2_handler.js') }}?v={{ (now.strftime('%Y%m%d%H%M%S') if now is callable else now.strftime('%Y%m%d%H%M%S')) if now is defined else '' }}"></script>
    <script src="{{ url_for('static', filename='js/regular_event_handler.js') }}?v={{ (now.strftime('%Y%m%d%H%M%S') if now is callable else now.strftime('%Y%m%d%H%M%S')) if now is defined else '' }}"></script>
    
    <!-- 最后加载主游戏脚本 -->
    <script src="{{ url_for('static', filename='js/game.js') }}?v={{ (now.strftime('%Y%m%d%H%M%S') if now is callable else now.strftime('%Y%m%d%H%M%S')) if now is defined else '' }}"></script>
    
    <!-- 初始化游戏实例 -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            window.gameInitMarker('DOM内容加载完成，准备初始化游戏');
            
            // 创建静音的音频上下文来解锁音频
            const unlockAudio = function() {
                // 创建音频上下文
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // 创建空白音频节点
                const emptyNode = audioContext.createBufferSource();
                emptyNode.start();
                emptyNode.stop();
                
                // 移除事件监听器
                document.removeEventListener('click', unlockAudio);
                document.removeEventListener('touchstart', unlockAudio);
                document.removeEventListener('keydown', unlockAudio);
                
                console.log('[音频] 音频上下文已解锁，可以播放声音');
            };
            
            // 添加事件监听器以解锁音频
            document.addEventListener('click', unlockAudio);
            document.addEventListener('touchstart', unlockAudio);
            document.addEventListener('keydown', unlockAudio);
            
            // 确保事件处理器先初始化
            setTimeout(function() {
                try {
                    window.gameInitMarker('开始创建游戏实例');
                    window.currentGame = new Game();
                    window.gameInitMarker('游戏实例创建成功');
                    
                    // 添加全局点击事件用于调试
                    document.body.addEventListener('click', function(e) {
                        console.log('[DEBUG] 点击事件被触发', e.target);
                        
                        // 确保当前事件已加载完成且有音乐控制器时，开始播放音乐
                        if (window.currentGame && window.currentGame.currentEvent && 
                            window.currentGame.playEventMusic && 
                            (!window.currentGame.backgroundMusic || window.currentGame.backgroundMusic.paused)) {
                            
                            // 播放当前事件类型的音乐
                            const eventType = window.currentGame.currentEvent.type;
                            const isQuizPhase = window.currentGame.hasStartedQuiz && 
                                              !window.currentGame.hasCompletedQuiz && 
                                              eventType === 'weekend';
                            
                            window.currentGame.playEventMusic(eventType, isQuizPhase);
                            console.log(`[DEBUG] 点击启动音乐播放 - 事件类型: ${eventType}, 答题阶段: ${isQuizPhase}`);
                        }
                    });
                } catch(e) {
                    console.error('游戏初始化失败:', e);
                }
            }, 100);
        });
    </script>
</body>
</html> 